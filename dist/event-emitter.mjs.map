{"version":3,"sources":["../src/event-emitter.ts"],"sourcesContent":["export type EmitterEvent = {\n  [key: string]: any;\n  [key: number]: any;\n};\n\nexport type EventType<T extends EmitterEvent> = new (...args: any[]) => T;\nexport type EventListener<T extends EmitterEvent> = (event: T) => void;\ntype ListenerArray<T extends EmitterEvent> = Array<[EventListener<T>, boolean] | undefined>;\ntype EmitterFunction<T extends EmitterEvent> = (event: T, listeners: ListenerArray<T>) => void;\n\nclass EventDispatcher {\n  public readonly dispatch: EmitterFunction<EmitterEvent>;\n  constructor(\n    public readonly size: number,\n  ) {\n    let code = 'const len = listeners.length; let li;';\n    for (let i = 0; i < size; i++) {\n      code += `\\nif(${i} >= len) return;`;\n      code += `\\nli = listeners[${i}];`;\n      code += `\\nif(li?.[1]) listeners[${i}] = undefined;`;\n      code += `\\nli?.[0](event);`;\n    }\n    // eslint-disable-next-line no-new-func\n    this.dispatch = new Function('event', 'listeners', code) as EmitterFunction<EmitterEvent>;\n  }\n}\n\nexport class EventEmitter {\n  protected readonly listenerMap: Map<EventType<EmitterEvent>, ListenerArray<never>> = new Map();\n  protected eventDispatcher: EventDispatcher;\n  constructor(dispatchSize: number = 10) {\n    this.eventDispatcher = new EventDispatcher(dispatchSize);\n  }\n\n  public once<T extends EmitterEvent>(event: EventType<T>, listener: EventListener<T>): this {\n    return this.add(event, listener, true);\n  }\n\n  public on<T extends EmitterEvent>(event: EventType<T>, listener: EventListener<T>): this {\n    return this.add(event, listener);\n  }\n\n  public off<T extends EmitterEvent>(event: EventType<T>, listener?: EventListener<T>): this {\n    if (listener) {\n      const listeners = this.listenerMap.get(event);\n      if (listeners) {\n        const filtered = listeners.filter(entry => entry && entry[0] !== listener);\n        if (filtered.length > 0) {\n          this.listenerMap.set(event, filtered);\n        }\n        else {\n          this.listenerMap.delete(event);\n        }\n      }\n    }\n    else {\n      this.listenerMap.delete(event);\n    }\n    return this;\n  }\n\n  public emit<T extends EmitterEvent>(event: T): this {\n    const type = event.constructor as EventType<T>;\n    const listeners = this.listenerMap.get(type) as ListenerArray<EmitterEvent> | undefined;\n    if (listeners) {\n      this.eventDispatcher.dispatch(event, listeners);\n    }\n    return this;\n  }\n\n  public listeners<T extends EmitterEvent>(event: EventType<T>): EventListener<T>[] {\n    const listeners = this.listenerMap.get(event);\n    if (listeners) {\n      return listeners\n        .filter((entry): entry is [EventListener<T>, boolean] => !!entry)\n        .map(([li]) => li);\n    }\n    return [];\n  }\n\n  public events(): EventType<EmitterEvent>[] {\n    return Array.from(this.listenerMap.keys());\n  }\n\n  public clear(): this {\n    this.listenerMap.clear();\n    return this;\n  }\n\n  protected add<T extends EmitterEvent>(\n    event: EventType<T>,\n    listener: EventListener<T>,\n    once: boolean = false,\n  ): this {\n    const listeners = this.listenerMap.get(event);\n    let count = 1;\n    if (listeners) {\n      const filtered = listeners.filter(entry => entry && entry[0] !== listener);\n      this.listenerMap.set(event, [...filtered, [listener, once]]);\n      count += filtered.length;\n    }\n    else {\n      this.listenerMap.set(event, [[listener, once]]);\n    }\n    if (count > this.eventDispatcher.size) {\n      this.eventDispatcher = new EventDispatcher(count);\n    }\n    return this;\n  }\n}\n"],"mappings":";AAUA,IAAM,kBAAN,MAAsB;AAAA,EAEpB,YACkB,MAChB;AADgB;AAEhB,QAAI,OAAO;AACX,aAAS,IAAI,GAAG,IAAI,MAAM,KAAK;AAC7B,cAAQ;AAAA,KAAQ,CAAC;AACjB,cAAQ;AAAA,iBAAoB,CAAC;AAC7B,cAAQ;AAAA,wBAA2B,CAAC;AACpC,cAAQ;AAAA;AAAA,IACV;AAEA,SAAK,WAAW,IAAI,SAAS,SAAS,aAAa,IAAI;AAAA,EACzD;AACF;AAEO,IAAM,eAAN,MAAmB;AAAA,EAGxB,YAAY,eAAuB,IAAI;AAFvC,SAAmB,cAAkE,oBAAI,IAAI;AAG3F,SAAK,kBAAkB,IAAI,gBAAgB,YAAY;AAAA,EACzD;AAAA,EAEO,KAA6B,OAAqB,UAAkC;AACzF,WAAO,KAAK,IAAI,OAAO,UAAU,IAAI;AAAA,EACvC;AAAA,EAEO,GAA2B,OAAqB,UAAkC;AACvF,WAAO,KAAK,IAAI,OAAO,QAAQ;AAAA,EACjC;AAAA,EAEO,IAA4B,OAAqB,UAAmC;AACzF,QAAI,UAAU;AACZ,YAAM,YAAY,KAAK,YAAY,IAAI,KAAK;AAC5C,UAAI,WAAW;AACb,cAAM,WAAW,UAAU,OAAO,WAAS,SAAS,MAAM,CAAC,MAAM,QAAQ;AACzE,YAAI,SAAS,SAAS,GAAG;AACvB,eAAK,YAAY,IAAI,OAAO,QAAQ;AAAA,QACtC,OACK;AACH,eAAK,YAAY,OAAO,KAAK;AAAA,QAC/B;AAAA,MACF;AAAA,IACF,OACK;AACH,WAAK,YAAY,OAAO,KAAK;AAAA,IAC/B;AACA,WAAO;AAAA,EACT;AAAA,EAEO,KAA6B,OAAgB;AAClD,UAAM,OAAO,MAAM;AACnB,UAAM,YAAY,KAAK,YAAY,IAAI,IAAI;AAC3C,QAAI,WAAW;AACb,WAAK,gBAAgB,SAAS,OAAO,SAAS;AAAA,IAChD;AACA,WAAO;AAAA,EACT;AAAA,EAEO,UAAkC,OAAyC;AAChF,UAAM,YAAY,KAAK,YAAY,IAAI,KAAK;AAC5C,QAAI,WAAW;AACb,aAAO,UACJ,OAAO,CAAC,UAAgD,CAAC,CAAC,KAAK,EAC/D,IAAI,CAAC,CAAC,EAAE,MAAM,EAAE;AAAA,IACrB;AACA,WAAO,CAAC;AAAA,EACV;AAAA,EAEO,SAAoC;AACzC,WAAO,MAAM,KAAK,KAAK,YAAY,KAAK,CAAC;AAAA,EAC3C;AAAA,EAEO,QAAc;AACnB,SAAK,YAAY,MAAM;AACvB,WAAO;AAAA,EACT;AAAA,EAEU,IACR,OACA,UACA,OAAgB,OACV;AACN,UAAM,YAAY,KAAK,YAAY,IAAI,KAAK;AAC5C,QAAI,QAAQ;AACZ,QAAI,WAAW;AACb,YAAM,WAAW,UAAU,OAAO,WAAS,SAAS,MAAM,CAAC,MAAM,QAAQ;AACzE,WAAK,YAAY,IAAI,OAAO,CAAC,GAAG,UAAU,CAAC,UAAU,IAAI,CAAC,CAAC;AAC3D,eAAS,SAAS;AAAA,IACpB,OACK;AACH,WAAK,YAAY,IAAI,OAAO,CAAC,CAAC,UAAU,IAAI,CAAC,CAAC;AAAA,IAChD;AACA,QAAI,QAAQ,KAAK,gBAAgB,MAAM;AACrC,WAAK,kBAAkB,IAAI,gBAAgB,KAAK;AAAA,IAClD;AACA,WAAO;AAAA,EACT;AACF;","names":[]}