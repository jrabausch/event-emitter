{"version":3,"sources":["../src/index.ts","../src/loop-event-dispatcher.ts","../src/event-emitter.ts","../src/function-event-dispatcher.ts"],"sourcesContent":["export { EventEmitter } from './event-emitter';\nexport { FunctionEventDispatcher } from './function-event-dispatcher';\nexport { LoopEventDispatcher } from './loop-event-dispatcher';\nexport type {\n  EmitterEvent,\n  EventDispatcher,\n  EventListener,\n  EventType,\n  ListenerArray,\n  ListenerConfig,\n} from './types';\n","import type { EmitterEvent, EventDispatcher, ListenerArray } from './types';\n\nexport class LoopEventDispatcher implements EventDispatcher {\n  public dispatch<T extends EmitterEvent>(event: T, listeners: ListenerArray<T>): number {\n    const length = listeners.length;\n    let count = 0;\n    for (let i = 0; i < length; i++) {\n      const entry = listeners[i];\n      if (!entry) {\n        continue;\n      }\n      if (entry.once) {\n        listeners[i] = undefined;\n      }\n      entry.listener(event);\n      count++;\n    }\n    return count;\n  };\n}\n","import type {\n  EmitterEvent,\n  EventDispatcher,\n  EventListener,\n  EventType,\n  ListenerArray,\n  ListenerConfig,\n} from './types';\nimport { LoopEventDispatcher } from './loop-event-dispatcher';\n\nexport class EventEmitter {\n  protected readonly listenerMap: Map<EventType<EmitterEvent>, ListenerArray<never>> = new Map();\n\n  constructor(\n    protected readonly dispatcher: EventDispatcher = new LoopEventDispatcher(),\n  ) { }\n\n  public once<T extends EmitterEvent>(event: EventType<T>, listener: EventListener<T>): this {\n    return this.add(event, listener, true);\n  }\n\n  public on<T extends EmitterEvent>(event: EventType<T>, listener: EventListener<T>): this {\n    return this.add(event, listener);\n  }\n\n  public off<T extends EmitterEvent>(event: EventType<T>, listener?: EventListener<T>): this {\n    if (listener) {\n      const listeners = this.listenerMap.get(event);\n      if (listeners) {\n        const filtered = this.filter(listeners, listener);\n        if (filtered.length > 0) {\n          this.listenerMap.set(event, filtered);\n        }\n        else {\n          this.listenerMap.delete(event);\n        }\n      }\n    }\n    else {\n      this.listenerMap.delete(event);\n    }\n    return this;\n  }\n\n  public emit<T extends EmitterEvent>(event: T): number {\n    const type = event.constructor as EventType<T>;\n    const listeners = this.listenerMap.get(type) as ListenerArray<T> | undefined;\n    if (listeners) {\n      return this.dispatcher.dispatch(event, listeners);\n    }\n    return 0;\n  }\n\n  public listeners<T extends EmitterEvent>(event: EventType<T>): EventListener<T>[] {\n    const listeners = this.listenerMap.get(event) as ListenerArray<T> | undefined;\n    const filtered = [];\n    if (listeners) {\n      const length = listeners.length;\n      for (let i = 0; i < length; i++) {\n        const entry = listeners[i];\n        entry && filtered.push(entry.listener);\n      }\n    }\n    return filtered;\n  }\n\n  public events(): EventType<EmitterEvent>[] {\n    return Array.from(this.listenerMap.keys());\n  }\n\n  public clear(): this {\n    this.listenerMap.clear();\n    return this;\n  }\n\n  protected add<T extends EmitterEvent>(\n    event: EventType<T>,\n    listener: EventListener<T>,\n    once: boolean = false,\n  ): this {\n    const listeners = this.listenerMap.get(event);\n    const entry: ListenerConfig<T> = Object.create({ listener, once });\n    if (listeners) {\n      const filtered = this.filter(listeners, listener);\n      filtered.push(entry);\n      this.listenerMap.set(event, filtered);\n    }\n    else {\n      this.listenerMap.set(event, [entry]);\n    }\n    return this;\n  }\n\n  protected filter<T extends EmitterEvent>(\n    arr: ListenerArray<T>,\n    listener: EventListener<T>,\n  ): ListenerArray<T> {\n    const filtered = [];\n    const length = arr.length;\n    for (let i = 0; i < length; i++) {\n      const entry = arr[i];\n      if (entry && entry.listener !== listener) {\n        filtered.push(entry);\n      }\n    }\n    return filtered;\n  }\n}\n","import type { EmitterEvent, EventDispatcher, ListenerArray } from './types';\n\nexport class FunctionEventDispatcher implements EventDispatcher {\n  protected dispatchFunction: this['dispatch'];\n\n  constructor(\n    protected size: number = 10,\n  ) {\n    this.dispatchFunction = this.createFunction(size);\n  }\n\n  public dispatch<T extends EmitterEvent>(event: T, listeners: ListenerArray<T>): number {\n    const length = listeners.length;\n    if (length > this.size) {\n      this.size = length + 10;\n      this.dispatchFunction = this.createFunction(this.size);\n    }\n    return this.dispatchFunction(event, listeners);\n  };\n\n  protected createFunction(size: number): this['dispatch'] {\n    let code = 'var len = arr.length, count = 0, li;';\n    for (let i = 0; i < size; i++) {\n      code += `\\nif(${i} === len) return count;`;\n      code += `\\nif(li = arr[${i}]){ if(li.once) arr[${i}] = undefined; li.listener(ev); count++; }`;\n    }\n    code += `\\nif(${size} === len) return count;`;\n    code += `\\nthrow new RangeError('Dispatch function too small: ' + len + ' > ${size}');`;\n    // eslint-disable-next-line no-new-func\n    return new Function('ev', 'arr', code) as this['dispatch'];\n  }\n}\n"],"mappings":"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","names":[]}