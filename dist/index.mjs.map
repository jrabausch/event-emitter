{"version":3,"sources":["../src/loop-event-dispatcher.ts","../src/seek-map.ts","../src/event-emitter.ts","../src/function-event-dispatcher.ts"],"sourcesContent":["import type { EmitterEvent, EventDispatcher, ListenerArray } from './types';\n\nexport class LoopEventDispatcher implements EventDispatcher {\n  public dispatch<T extends EmitterEvent>(event: T, listeners: ListenerArray<T>): number {\n    const length = listeners.length;\n    let count = 0;\n    for (let i = 0; i < length; i++) {\n      const entry = listeners[i];\n      if (!entry) {\n        continue;\n      }\n      if (entry[1]) {\n        listeners[i] = undefined;\n      }\n      entry[0](event);\n      count++;\n    }\n    return count;\n  };\n}\n","export class SeekMap<K, V> {\n  protected readonly keyArray: K[] = [];\n  protected readonly valueStore: Record<number, V> = {};\n\n  constructor() { }\n\n  get size() {\n    return this.keyArray.length;\n  }\n\n  public clear(): void {\n    this.keyArray.length = 0;\n    const values = this.valueStore;\n    for (const key in values) {\n      delete values[key];\n    }\n  }\n\n  public keys(): K[] {\n    return [...this.keyArray];\n  }\n\n  public set(key: K, value: V): this {\n    const keys = this.keyArray;\n    const values = this.valueStore;\n    const length = keys.length;\n    for (let i = 0; i < length; i++) {\n      if (keys[i] === key) {\n        values[i] = value;\n        return this;\n      }\n    }\n    const index = keys.push(key) - 1;\n    values[index] = value;\n    return this;\n  }\n\n  public get(key: K): V | undefined {\n    const keys = this.keyArray;\n    const length = keys.length;\n    for (let i = 0; i < length; i++) {\n      if (keys[i] === key) {\n        return this.valueStore[i];\n      }\n    }\n    return undefined;\n  }\n\n  public has(key: K): boolean {\n    const keys = this.keyArray;\n    const length = keys.length;\n    for (let i = 0; i < length; i++) {\n      if (keys[i] === key) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  public delete(key: K): boolean {\n    const keys = this.keyArray;\n    const length = keys.length;\n    for (let i = 0; i < length; i++) {\n      if (keys[i] !== key) {\n        continue;\n      }\n      delete this.valueStore[i];\n      if (i === 0) {\n        keys.shift();\n      }\n      else if (i === length - 1) {\n        keys.length = i;\n      }\n      else {\n        keys.splice(i, 1);\n      }\n      return true;\n    }\n    return false;\n  }\n}\n","import type {\n  EmitterEvent,\n  EventDispatcher,\n  EventListener,\n  EventType,\n  ListenerArray,\n  ListenerConfig,\n} from './types';\nimport { LoopEventDispatcher } from './loop-event-dispatcher';\nimport { SeekMap } from './seek-map';\n\nexport class EventEmitter {\n  protected readonly listenerMap: SeekMap<EventType<EmitterEvent>, ListenerArray<never>> = new SeekMap();\n\n  constructor(\n    protected readonly dispatcher: EventDispatcher = new LoopEventDispatcher(),\n  ) { }\n\n  public once<T extends EmitterEvent>(event: EventType<T>, listener: EventListener<T>): this {\n    return this.add(event, listener, true);\n  }\n\n  public on<T extends EmitterEvent>(event: EventType<T>, listener: EventListener<T>): this {\n    return this.add(event, listener);\n  }\n\n  public off<T extends EmitterEvent>(event: EventType<T>, listener?: EventListener<T>): this {\n    if (listener) {\n      const listeners = this.listenerMap.get(event);\n      if (listeners) {\n        const filtered = this.filter(listeners, listener);\n        if (filtered.length > 0) {\n          this.listenerMap.set(event, filtered);\n        }\n        else {\n          this.listenerMap.delete(event);\n        }\n      }\n    }\n    else {\n      this.listenerMap.delete(event);\n    }\n    return this;\n  }\n\n  public emit<T extends EmitterEvent>(event: T): number {\n    const type = event.constructor as EventType<T>;\n    const listeners = this.listenerMap.get(type) as ListenerArray<T> | undefined;\n    if (listeners) {\n      return this.dispatcher.dispatch(event, listeners);\n    }\n    return 0;\n  }\n\n  public listeners<T extends EmitterEvent>(event: EventType<T>): EventListener<T>[] {\n    const listeners = this.listenerMap.get(event) as ListenerArray<T> | undefined;\n    const filtered = [];\n    if (listeners) {\n      const length = listeners.length;\n      for (let i = 0; i < length; i++) {\n        const entry = listeners[i];\n        entry && filtered.push(entry[0]);\n      }\n    }\n    return filtered;\n  }\n\n  public events(): EventType<EmitterEvent>[] {\n    return Array.from(this.listenerMap.keys());\n  }\n\n  public clear(): this {\n    this.listenerMap.clear();\n    return this;\n  }\n\n  protected add<T extends EmitterEvent>(\n    event: EventType<T>,\n    listener: EventListener<T>,\n    once: boolean = false,\n  ): this {\n    const listeners = this.listenerMap.get(event);\n    const entry: ListenerConfig<T> = [listener, once];\n    if (listeners) {\n      const filtered = this.filter(listeners, listener);\n      filtered.push(entry);\n      this.listenerMap.set(event, filtered);\n    }\n    else {\n      this.listenerMap.set(event, [entry]);\n    }\n    return this;\n  }\n\n  protected filter<T extends EmitterEvent>(\n    arr: ListenerArray<T>,\n    listener: EventListener<T>,\n  ): ListenerArray<T> {\n    const filtered = [];\n    const length = arr.length;\n    for (let i = 0; i < length; i++) {\n      const entry = arr[i];\n      if (entry && entry[0] !== listener) {\n        filtered.push(entry);\n      }\n    }\n    return filtered;\n  }\n}\n","import type { EmitterEvent, EventDispatcher, ListenerArray } from './types';\n\nexport class FunctionEventDispatcher implements EventDispatcher {\n  protected dispatchFunction: this['dispatch'];\n\n  constructor(\n    protected size: number = 10,\n  ) {\n    this.dispatchFunction = this.createFunction(size);\n  }\n\n  public dispatch<T extends EmitterEvent>(event: T, listeners: ListenerArray<T>): number {\n    const length = listeners.length;\n    if (length > this.size) {\n      this.size = length + 10;\n      this.dispatchFunction = this.createFunction(this.size);\n    }\n    return this.dispatchFunction(event, listeners);\n  };\n\n  protected createFunction(size: number): this['dispatch'] {\n    let code = 'var len = arr.length, count = 0, li;';\n    for (let i = 0; i < size; i++) {\n      code += `\\nif(${i} === len) return count;`;\n      code += `\\nif(li = arr[${i}]){ if(li[1]) arr[${i}] = undefined; li[0](ev); count++; }`;\n    }\n    code += `\\nif(${size} === len) return count;`;\n    code += `\\nthrow new RangeError('Dispatch function too small: ' + len + ' > ${size}');`;\n    // eslint-disable-next-line no-new-func\n    return new Function('ev', 'arr', code) as this['dispatch'];\n  }\n}\n"],"mappings":"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","names":[]}